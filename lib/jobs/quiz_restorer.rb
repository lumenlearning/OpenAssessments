require 'set'

class QuizRestorer
  def initialize
    @assessment_ids = [7350, 7359, 7358, 7357, 7356, 7355, 7354, 7353, 7352, 7351, 12913, 7791, 7790, 7789, 7788, 12917, 7810, 7809, 7808, 10149, 10145, 9715, 10146, 9712, 3048, 3052, 3051, 3050, 3049, 2981, 2985, 2984, 2983, 2982, 3053, 3058, 3057, 3056, 3055, 3054, 3059, 3066, 3065, 3064, 3063, 3062, 3061, 3060, 7336, 7342, 7341, 7340, 7339, 7338, 7337, 10349, 10355, 10354, 10353, 10352, 10351, 10350, 2964, 2972, 2971, 2970, 2969, 2968, 2967, 2966, 2965, 7343, 7349, 7348, 7347, 7346, 7345, 7344, 12891, 7771, 7770, 7769, 7768, 7767, 7305, 7310, 7309, 7308, 7307, 7306, 7360, 7366, 7365, 7364, 7363, 7362, 7361, 3032, 3038, 3037, 3036, 3035, 3034, 3033, 12889, 7754, 7753, 7752, 7751, 10325, 10329, 10328, 10327, 10326, 12915, 7801, 7800, 7799, 7798, 10363, 10372, 10371, 10370, 10369, 10368, 10367, 10366, 10365, 10364, 3025, 3031, 3030, 3029, 3028, 3027, 3026, 10373, 10379, 10378, 10377, 10376, 10375, 10374, 5147, 5152, 5151, 5150, 5149, 5148, 12890, 7760, 7759, 7758, 7757, 7756, 5159, 5164, 5163, 5162, 5161, 5160, 3017, 3024, 3023, 3022, 3021, 3020, 3019, 3018, 10319, 10324, 10323, 10322, 10321, 10320, 10345, 10348, 10347, 10346, 2986, 2994, 2993, 2992, 2991, 2990, 2989, 2988, 2987, 12858, 7749, 7748, 7747, 7746, 2995, 3000, 2999, 2998, 2997, 2996, 3001, 3009, 3008, 3007, 3006, 3005, 3004, 3003, 3002, 10380, 10385, 10384, 10383, 10382, 10381, 5589, 5593, 5592, 5591, 5590, 7367, 7372, 7371, 7370, 7369, 7368, 3010, 3016, 3015, 3014, 3013, 3012, 3011, 3039, 3047, 3046, 3045, 3044, 3043, 3042, 3041, 3040, 12911, 7782, 7781, 7780, 7779, 10356, 10362, 10361, 10360, 10359, 10358, 10357, 9711, 9715, 9714, 9713, 9712, 10216, 7330, 7333, 7331, 12912, 7786, 7821, 7785, 7784, 7311, 7314, 7313, 7312, 7315, 7324, 7323, 7322, 7321, 7320, 7319, 7318, 7317, 7316, 5579, 5583, 5582, 5581, 5580, 5165, 5170, 5169, 5168, 5167, 5166, 12914, 7796, 7795, 7794, 7793, 7816, 7820, 7819, 7818, 7817, 10340, 10344, 10343, 10342, 10341, 7761, 7765, 7764, 7763, 7762, 7004, 7007, 7006, 7005, 2973, 2980, 2979, 2978, 2977, 2976, 2975, 2974, 2956, 2963, 2962, 2961, 2960, 2959, 2958, 2957, 10330, 10339, 10338, 10337, 10336, 10335, 10334, 10333, 10332, 10331, 12892, 7777, 7776, 7775, 7774, 7773, 5153, 5158, 5157, 5156, 5155, 5154, 5584, 5588, 5587, 5586, 5585, 7325, 7329, 7328, 7327, 7326, 3067, 3073, 3072, 3071, 3070, 3069, 3068, 12916, 7806, 7805, 7804, 7803, 5594, 5598, 5597, 5596, 5595, 12918, 7815, 7814, 7813, 7812,  3355, 3359, 3358, 3357, 3356, 3303, 3308, 3307, 3306, 3305, 3304, 4961, 4965, 4964, 4963, 4962, 3330, 3334, 3333, 3332, 3331, 3371, 3376, 3375, 3374, 3373, 3372, 4939, 4943, 4942, 4941, 4940, 3317, 3323, 3322, 3321, 3320, 3319, 3318, 5052, 5057, 5056, 5055, 5054, 5053, 5042, 5046, 5045, 5044, 5043, 3360, 3365, 3364, 3363, 3362, 3361, 4926, 4931, 4930, 4929, 4928, 4927, 4954, 4960, 4959, 4958, 4957, 4956, 4955, 4966, 4973, 4972, 4971, 4970, 4969, 4968, 4967, 3324, 3329, 3328, 3327, 3326, 3325, 4944, 4949, 4948, 4947, 4946, 4945, 4990, 4995, 4994, 4993, 4992, 4991, 4996, 5002, 5001, 5000, 4999, 4998, 4997, 3309, 3316, 3315, 3314, 3313, 3312, 3311, 3310, 3309, 3316, 3315, 3314, 3313, 3312, 3311, 3310, 4926, 4931, 4930, 4929, 4928, 4927, 3341, 3346, 3345, 3344, 3343, 3342, 5153, 5158, 5157, 5156, 5155, 5154, 5003, 5008, 5007, 5006, 5005, 5004, 4914, 4919, 4918, 4917, 4916, 4915, 3366, 3370, 3369, 3368, 3367, 3341, 3346, 3345, 3344, 3343, 3342, 3324, 3329, 3328, 3327, 3326, 3325, 4920, 4925, 4924, 4923, 4922, 4921, 5058, 5063, 5062, 5061, 5060, 5059, 3330, 3334, 3333, 3332, 3331, 3330, 3334, 3333, 3332, 3331, 5584, 5588, 5587, 5586, 5585, 5159, 5164, 5163, 5162, 5161, 5160, 5589, 5593, 5592, 5591, 5590, 3309, 3316, 3315, 3314, 3313, 3312, 3311, 3310, 3317, 3323, 3322, 3321, 3320, 3319, 3318, 3347, 3354, 3353, 3352, 3351, 3350, 3349, 3348, 5071, 5076, 5075, 5074, 5073, 5072, 3317, 3323, 3322, 3321, 3320, 3319, 3318, 3347, 3354, 3353, 3352, 3351, 3350, 3349, 3348, 3355, 3359, 3358, 3357, 3356, 7004, 7007, 7006, 7005, 3371, 3376, 3375, 3374, 3373, 3372, 3335, 3340, 3339, 3338, 3337, 3336, 5009, 5016, 5015, 5014, 5013, 5012, 5011, 5010, 4932, 4938, 4937, 4936, 4935, 4934, 4933, 5024, 5029, 5028, 5027, 5026, 5025, 3347, 3354, 3353, 3352, 3351, 3350, 3349, 3348, 5147, 5152, 5151, 5150, 5149, 5148, 3303, 3308, 3307, 3306, 3305, 3304, 3335, 3340, 3339, 3338, 3337, 3336, 5036, 5040, 5039, 5038, 5037, 3360, 3365, 3364, 3363, 3362, 3361, 4950, 4953, 4952, 4951, 5594, 5598, 5597, 5596, 5595, 5165, 5170, 5169, 5168, 5167, 5166, 5579, 5583, 5582, 5581, 5580, 3377, 3382, 3381, 3380, 3379, 3378, 5017, 5023, 5022, 5021, 5020, 5019, 5018, 3366, 3370, 3369, 3368, 3367, 4974, 4980, 4979, 4978, 4977, 4976, 4975, 5030, 5035, 5034, 5033, 5032, 5031, 4981, 4989, 4988, 4987, 4986, 4985, 4984, 4983, 4982, 3371, 3376, 3375, 3374, 3373, 3372, 3366, 3370, 3369, 3368, 3367, 5064, 5070, 5069, 5068, 5067, 5066, 5065, 5047, 5051, 5050, 5049, 5048, 3341, 3346, 3345, 3344, 3343, 3342, 3303, 3308, 3307, 3306, 3305, 3304, 3377, 3382, 3381, 3380, 3379, 3378, 3383, 3387, 3386, 3385, 3384, 3335, 3340, 3339, 3338, 3337, 3336, 3324, 3329, 3328, 3327, 3326, 3325, 3383, 3387, 3386, 3385, 3384, 3360, 3365, 3364, 3363, 3362, 3361, 3355, 3359, 3358, 3357, 3356, 3377, 3382, 3381, 3380, 3379, 3378, 3383, 3387, 3386, 3385, 3384,  7350, 7359, 7358, 7357, 7356, 7355, 7354, 7353, 7352, 7351, 2205, 2214, 2213, 2212, 2211, 2210, 2209, 2208, 2207, 2206, 10149, 10145, 9715, 10146, 9712, 2198, 2204, 2203, 2202, 2201, 2200, 2199, 13000, 6845, 6850, 6849, 6848, 6847, 2170, 2179, 2178, 2177, 2176, 2175, 2174, 2173, 2172, 2171, 6687, 6666, 6665, 6664, 6663, 6662, 6688, 6680, 6686, 6685, 6684, 6683, 6682, 6681, 6882, 6890, 6889, 6888, 6887, 6886, 6885, 6884, 6883, 7336, 7342, 7341, 7340, 7339, 7338, 7337, 2215, 2221, 2220, 2219, 2218, 2217, 2216, 6640, 6646, 6645, 6644, 6643, 6642, 6641, 2165, 2169, 2168, 2167, 2166, 7343, 7349, 7348, 7347, 7346, 7345, 7344, 6919, 6923, 6922, 6921, 6920, 2222, 2227, 2226, 2225, 2224, 2223, 7305, 7310, 7309, 7308, 7307, 7306, 7360, 7366, 7365, 7364, 7363, 7362, 7361, 6673, 6679, 6678, 6677, 6676, 6675, 6674, 6695, 6700, 6699, 6698, 6697, 6696, 6874, 6881, 6880, 6879, 6878, 6877, 6876, 6875, 2159, 2164, 2163, 2162, 2161, 2160, 6667, 6672, 6671, 6670, 6669, 6668, 6714, 6720, 6719, 6718, 6717, 6716, 6715, 2215, 2221, 2220, 2219, 2218, 2217, 2216, 6913, 6918, 6917, 6916, 6915, 6914, 6633, 6639, 6638, 6637, 6636, 6635, 6634, 2205, 2214, 2213, 2212, 2211, 2210, 2209, 2208, 2207, 2206, 6907, 6912, 6911, 6910, 6909, 6908, 2180, 2184, 2183, 2182, 2181, 6851, 6855, 6854, 6853, 6852, 6891, 6895, 6894, 6893, 6892, 6902, 6906, 6905, 6904, 6903, 2222, 2227, 2226, 2225, 2224, 2223, 6707, 6713, 6712, 6711, 6710, 6709, 6708, 2191, 2197, 2196, 2195, 2194, 2193, 2192, 8109, 8108, 2185, 2190, 2189, 2187, 6689, 6694, 6693, 6692, 6691, 6690, 6864, 6868, 6867, 6866, 6865, 6869, 6873, 6872, 6871, 6870, 7367, 7372, 7371, 7370, 7369, 7368, 6737, 6743, 6742, 6741, 6740, 6739, 6738, 6856, 6863, 6862, 6861, 6860, 6859, 6858, 6857, 2159, 2164, 2163, 2162, 2161, 2160, 6656, 6661, 6660, 6659, 6658, 6657, 2180, 2184, 2183, 2182, 2181, 10216, 7330, 7333, 7331, 7311, 7314, 7313, 7312, 7315, 7324, 7323, 7322, 7321, 7320, 7319, 7318, 7317, 7316, 6896, 6901, 6900, 6899, 6898, 6897, 8107, 8106, 8105, 2168, 2166, 2170, 2179, 2178, 2177, 2176, 2175, 2174, 2173, 2172, 2171, 2198, 2204, 2203, 2202, 2201, 2200, 2199, 6727, 6736, 6735, 6734, 6733, 6732, 6731, 6730, 6729, 6728, 6647, 6655, 6654, 6653, 6652, 6651, 6650, 6649, 6648, 2191, 2197, 2196, 2195, 2194, 2193, 2192, 7325, 7329, 7328, 7327, 7326, 6701, 6706, 6705, 6704, 6703, 6702, 2185, 2190, 2189, 2188, 2187, 2186, 6721, 6726, 6725, 6724, 6723, 6722]
    @fixed_ua_attempts = Set.new
    @time_range = 24.hours
  end

  def perform
    Kernel.loop do
      restore_quizzes
      puts "back to sleep"
      sleep 3600
    end
  end

  private

  def restore_quizzes
    @assessment_ids.each do |assessment_id|
      restore_quizzes_for_assessment(assessment_id)
    end
  end

  def retrieve_assessment_results(assessment_id)
    now = Time.now
    AssessmentResult.where(assessment_id: assessment_id,
      updated_at: ((now - time_range)..now),
      session_status: "pendingSubmission")
  end

  def has_duplicate_lti_launches?(assessment_result)
    AssessmentResult.where(lti_launch_id: assessment_result.lti_launch_id).count() > 1
  end

  def check_user_assessment(assessment_result)
    ua = assessment_result.user_assessment
    if should_restore_quiz?(ua)
      restore_quiz!(ua)
      @fixed_ua_attempts << ua.id
    end
  end

  def should_restore_quiz?(user_assessment)
    !@fixed_ua_attempts.include?(user_assessment.id) &&
    user_assessment.attempts > 0 &&
    user_assessment.attempts == user_assessment.assessment_results.count()
  end

  # does the user assessment have an attempt left and was one of the launches have all assessment results with session
  # status in "pendingSubmission" and no progresses for either?  Then the student gets _another_ quiz back because
  # OEA basically stole _two_ of them
  def should_restore_second_quiz?(user_assessment)
    user_assessment.attempts > 0 &&
    !(user_assessment.assessment_results.group_by { |v| v.lti_launch_id }.values.select { |gar| gar.all? { |sar| sar.session_status == "pendingSubmission" and sar.progress.nil? } }).empty?
  end

  def restore_quiz!(user_assessment)
    puts "updating UserAssessment #{ua.id}"
    user_assessment.attempts -= 1
    if should_restore_second_quiz?(ua)
      puts "second quiz restored for #{ua.id} because the first one never went through"
      user_assessment.attempts -= 1
    end
    user_assessment.save!
  end

  def restore_quizzes_for_assessment(assessment_id)
    retrieve_assessment_results(assessment_id).each do |assessment_result|
      if has_duplicate_lti_launches?(assessment_result)
        check_user_assessment(assessment_result)
      end
    end
  end
end
